SSO/session共享



# 详解Session分布式共享

2018-06-22 21:04

**一、前言&回顾**

在上篇文章Session分布式共享 = Session + Redis + Nginx中，好多同学留言问了我好多问题，其中印象深刻的有：nginx挂了怎么办？采用Redis的Session方案与微软Session方案相比，有什么优势呢？Cookie也可以取代Session的，采用Redis的Session方案优势在哪里？Nginx的iphash方式到底是什么？MachineKey有啥用？Net Core怎样实现？

那会儿看到大家的提问，我的回答也只是从应用层面回答，基本上的回答可以总结为：“别人这么做了，解决了这个问题，我用这个方法也解决了这个问题，原理请看链接。”很惭愧的说，那时的我并没有完全理解他真正的优势在哪里，只是凭着直觉和经验知道这样做比较好，知道当一部分东西不可控时候，将其解耦、可视化、集群就可以让一个系统更加健壮，但没有一个理论支撑。经过最近一段时间的查阅资料和阅读书籍，对此有了深刻理解，本文将从网站架构的可用性角度对这种Session共享进行分析和讲解，并用.net core再次实现这种架构模式。（Session分布式共享的net core版，因为工作没有机会应用到生产环境，过往经验就更别提了，所以只是研究性的，请大家注意，但园子里早有大牛写出了相关文章，本文结束会将相关文章贴出）

**二、网站可用性--Session管理**

可用性是网站架构中非常重要的一环，什么是可用性，说的简单些，就是用户随时随地打开这个网站，这个网站都能打开，并且里面的功能都能用。如果可用性不高会出现什么情况？大家想象一下春节在12306抢票的情景，网站各种崩溃，大家保准会想：要是有别的方式能买到票，我才不用12306这个破网站呢。这个例子有点极端，因为业务场景比较极端，当然，这种现象也不光是网站可用性这一环出了问题。但是一个网站三天两头打不开，要么是点开了里面的页面到处是报错页面和操作无反应，你还会用这个网站么？我相信我们在浏览网站时候，只要不像12306这种垄断业务的网站，出现不可用的情况，我们一定会离开寻找其他类似的网站。

Session管理是网站可用性的内容之一，大家都知道Http是无状态请求，即无法追踪上次Http请求的相关信息，但是业务中大量需要将Http变为有状态请求，Session就随之产生了，可是在分布式网站设计中，无状态请求才能实现网站的横向拓展（增减应用服务器），因此又与Session相矛盾，因为Session信息如果存储在网站应用服务器的缓存中，加台服务器就不能用了，因此将Session解耦是解决此问题的关键，下面介绍网站常见的Session管理手段。

**1、Session复制**

Session复制是最早企业应用系统使用较多的一种服务集群Session管理机制，开启Session复制功能，即是在集群中的几台服务器之间同步Session对象，Java中好像JBoss有这个功能，.Net暂不知道。

**优势**：Session信息读取快，实现简单。

**缺点**：集群规模较大时，服务器之间Session复制会占用服务器资源和网络资源，最后系统会不堪重负。

![img](http://5b0988e595225.cdn.sohucs.com/images/20180622/df52e418a90f44559ac5478f7aee39bc.jpeg)

**2、Session绑定**

Session绑定的方式，一般软/硬均衡负载服务器都会提供此功能，例如：上篇文章Nginx的IPhash方式，均衡负载服务器利用Hash算法将同一IP分配到同一台服务器上，即Session绑定在某台特定服务器上，保证Session总能在这台服务器上获得，又称作为会话黏滞。

**缺点**：如果某台服务器宕机，那么这台服务器上面的Session也就不存在了，用户请求切换到其他服务器上因为没有Session而出错。

![img](http://5b0988e595225.cdn.sohucs.com/images/20180622/7fc56a9ec30841d3be3d9de73cb9a726.jpeg)

**3、利用Cookie记录Session**

通过Cookie记录Session信息是大部分网站采用的方法，这种方式只要Cookie不滥用，也是非常好非常成熟的方案。Cookie记录Session就是把一些状态信息放到了客户端，每次请求都要传输到服务器。

**优势**：这种方法简单易实现，可用性高，支持服务器横向拓展，方案成熟

**缺点**：安全性问题，Cookie有大小限制，而且每次请求传输Cookie会影响性能

![img](http://5b0988e595225.cdn.sohucs.com/images/20180622/c728a48ea5524bffadb10d614ee2e55e.jpeg)

**4、Session服务器**

Session服务器的方式管理Session，是一种非常好的解决方案，因为Session是为了业务需要Http状态而产生，而分布式网站设计中提倡Http无状态，为了满足这一设计，Session服务器是将有状态的Session信息与无状态的应用服务器相分离，再针对不同服务器的不同特性进行设计。例如：我们将Session信息存入到Redis中，那么Redis的集群配置、稳定性设置都有很多好的解决方案，如果将Session存入到Memcache，那么Memcache的集群配置、稳定性设置也会有很多成熟案例。这样我们就将一些问题简单化，如果我们单独应用.Net的Session，我们需要了解更多.Net深层次的东西并加以改造来保证其可用和稳定，越深层的东西越需要时间和阅历，而如果将Session存储介质转移到Redis中，Redis集群方案、管理工具都非常成熟，只需要配置配置就解决了Session的问题，何乐而不为呢。

**优势：**可用性高、安全性高、伸缩性好、性能高、信息大小无限制

![img](http://5b0988e595225.cdn.sohucs.com/images/20180622/5f5213c5b17347a68b76be148a6ead84.jpeg)